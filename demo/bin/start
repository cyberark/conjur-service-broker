#!/bin/bash -e

# stop will make sure PCFDev is running and the `cf` binary is installed
./demo/bin/stop

docker-compose up -d pg conjur

cf push --no-start

printf "Waiting for API key... "
while [ ! -f tmp/api_key ]
do
  sleep 1
done
echo "Done."

cf set-env conjur-service-broker CONJUR_ACCOUNT default
cf set-env conjur-service-broker CONJUR_APPLIANCE_URL http://host.pcfdev.io:3000/
cf set-env conjur-service-broker CONJUR_AUTHN_LOGIN admin
cf set-env conjur-service-broker CONJUR_AUTHN_API_KEY "$(cat tmp/api_key)"

cf start conjur-service-broker

APP_URL="http://`cf app conjur-service-broker | grep urls | awk '{print $2}'`"
cf create-service-broker conjur-service-broker "TEMPORARY" "TEMPORARY" $APP_URL
cf create-service conjur default conjur

pushd demo
  cf push
popd