#!/bin/bash -e

# stop will make sure PCFDev is running and the `cf` binary is installed
./demo/bin/stop

docker-compose up -d pg conjur

cf create-space demo
cf target -s demo

cf push --no-start --random-route

printf "Waiting for API key... "
while [[ ! -f tmp/api_key && -z `cat tmp/api_key` ]]
do
  sleep 1
done

while [[ -z `cat tmp/api_key` ]]
do
  sleep 1
done
echo "Done."

cf set-env conjur-service-broker CONJUR_ACCOUNT default
cf set-env conjur-service-broker CONJUR_APPLIANCE_URL http://host.pcfdev.io:3000/
cf set-env conjur-service-broker CONJUR_AUTHN_LOGIN admin
cf set-env conjur-service-broker CONJUR_AUTHN_API_KEY "$(cat tmp/api_key)"

cf start conjur-service-broker

APP_URL="http://`cf app conjur-service-broker | grep -E -w 'urls:|routes:' | awk '{print $2}'`"
cf create-service-broker conjur-service-broker "TEMPORARY" "TEMPORARY" $APP_URL --space-scoped

printf "Waiting for Conjur to be ready... "
while [[ ! `curl -X HEAD -is localhost:3000 | head -n1 | awk '{print $2}'` -eq '200' ]]
do
  sleep 1
done
echo "Done."

cf create-service conjur default conjur

pushd demo
  cf push --no-route
popd
