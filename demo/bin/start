#!/bin/bash -e

# stop will make sure PCFDev is running and the `cf` binary is installed
./demo/bin/stop

docker-compose up -d pg conjur

cf create-space demo
cf target -s demo

cf push --no-start --random-route

sleep 10

cf set-env conjur-service-broker CONJUR_ACCOUNT default
cf set-env conjur-service-broker CONJUR_APPLIANCE_URL http://host.pcfdev.io:3000/
cf set-env conjur-service-broker CONJUR_AUTHN_LOGIN admin
cf set-env conjur-service-broker CONJUR_AUTHN_API_KEY "$(cat tmp/api_key)"

cf start conjur-service-broker

APP_URL="http://`cf app conjur-service-broker | grep -E -w 'urls:|routes:' | awk '{print $2}'`"
cf create-service-broker conjur-service-broker "TEMPORARY" "TEMPORARY" $APP_URL --space-scoped
cf create-service conjur default conjur

pushd demo
  cf push
popd
